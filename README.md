# Lotto Game Backend

Простой backend на **Python 3.11 + FastAPI** для учета денежных расчетов в лото.

## Что уже реализовано

- Создание партии с параметрами:
  - цена карточки (`card_price_kopecks`)
  - доплата за линию (`line_bonus_kopecks`)
- События партии:
  - закрытие линии (может быть несколько победителей за событие)
  - закрытие карты (может быть несколько победителей)
- Ограничение: один и тот же игрок может закрыть линию только один раз за партию.
- Завершение партии с расчетом:
  - чистого баланса (`net`) по каждому игроку
  - списка переводов «кто кому должен» (`transfers`)
- Межпартийная статистика:
  - общий накопительный баланс по игрокам
  - количество завершенных партий
- Легкий фронт для сессий игр:
  - создание сессии
  - шаг «Кто закрыл линию?»
  - шаг «Кто закрыл карту?»
  - история игр в рамках одной сессии

## Правила расчета

1. В начале каждый игрок кладет в банк `card_price_kopecks`.
2. За каждое событие `line_closed` победителю(ям) платят все остальные по `line_bonus_kopecks`.
3. Банк делится между победителями(ем) карты (`card_closed`).
4. Все суммы хранятся в копейках (`int`) для точности.

## Быстрый старт

```bash
python -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
uvicorn app.main:app --reload
```

API будет доступно на `http://127.0.0.1:8000`, Swagger — `/docs`, UI сессии — `/`.

## Основные endpoints

- `POST /games` — создать игру
- `POST /games/{id}/events/line` — добавить закрытие линии
- `POST /games/{id}/events/card` — добавить закрытие карты
- `POST /games/{id}/finish` — завершить игру и зафиксировать результат
- `GET /games/{id}/settlement` — получить расчет завершенной игры
- `GET /stats/balance` — общий баланс по всем завершенным играм
- `POST /speech/transcribe` — принять аудио (`multipart/form-data`) и вернуть JSON с `text`, `language`, `provider`

### Endpoints сессий (новые)

- `POST /sessions` — создать сессию
- `POST /sessions/{id}/line` — выбрать победителей по линии для активной игры
- `POST /sessions/{id}/card` — выбрать победителей по карте для активной игры
- `POST /sessions/{id}/finish` — завершить активную игру и сохранить в историю
- `POST /sessions/{id}/new-game` — начать новую игру в той же сессии
- `GET /sessions/{id}` — получить состояние сессии и историю

## Тесты

```bash
pytest
```

## Frontend

В репозитории добавлен `frontend/` с демо-записью аудио через `MediaRecorder` и отправкой данных в `POST /speech/transcribe`.

